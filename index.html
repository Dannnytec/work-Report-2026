<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Reportes de Soporte</title>
    <!-- Tailwind CSS Load -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Configuration -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1f2937;
        }
        input[type="date"], input[type="time"] {
            height: 44px;
            color-scheme: dark;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-6 bg-gray-900 min-h-screen">

    <div class="max-w-xl mx-auto bg-gray-800 shadow-2xl rounded-xl p-6 space-y-6 border border-gray-700">
        <h1 class="text-3xl font-bold text-indigo-400 text-center border-b border-gray-700 pb-2 mb-4">
            Registro de Actividad de Soporte
        </h1>
        
        <!-- Estado de Conexión -->
        <div class="text-[10px] text-gray-400 p-2 bg-gray-700/50 rounded-lg flex justify-between items-center">
            <div class="flex items-center gap-2">
                <span id="aiIndicator" class="w-2 h-2 rounded-full bg-yellow-500"></span>
                <span id="aiStatus">Iniciando sistema...</span>
            </div>
            <div class="font-mono" id="authUserId">---</div>
        </div>

        <!-- Formulario de Entrada -->
        <div id="input-form" class="space-y-4">
            <div class="flex flex-col">
                <label for="supportType" class="text-xs font-bold text-gray-400 uppercase">Tipo de Soporte</label>
                <input type="text" id="supportType" value="Remote Support" class="mt-1 p-3 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-gray-700 text-white" />
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="flex flex-col">
                    <label for="dateInput" class="text-xs font-bold text-gray-400 uppercase">Fecha</label>
                    <input type="date" id="dateInput" class="mt-1 p-3 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-gray-700 text-white" />
                </div>
                <div class="flex flex-col">
                    <label for="startTimeInput" class="text-xs font-bold text-gray-400 uppercase">Hora de Inicio</label>
                    <input type="time" id="startTimeInput" class="mt-1 p-3 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-gray-700 text-white" />
                </div>
            </div>
            
            <div class="flex flex-col">
                <label for="endTimeInput" class="text-xs font-bold text-gray-400 uppercase">Hora de Finalización</label>
                <input type="time" id="endTimeInput" class="mt-1 p-3 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-gray-700 text-white" />
            </div>

            <div class="flex flex-col space-y-1">
                <label for="accountSelect" class="text-xs font-bold text-gray-400 uppercase">Cuenta/Cliente</label>
                <div class="flex space-x-2">
                    <select id="accountSelect" class="flex-grow p-3 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-gray-700 text-white">
                        <option value="" disabled selected>Cargando clientes...</option>
                    </select>
                    <button id="addClientBtn" onclick="openModal('addClientModal')" class="p-3 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition">
                        +
                    </button>
                </div>
            </div>
            
            <div class="flex flex-col">
                <label for="snInput" class="text-xs font-bold text-gray-400 uppercase">Número de Serie (SN)</label>
                <input type="text" id="snInput" placeholder="N/A" class="mt-1 p-3 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-gray-700 text-white" />
            </div>

            <div class="flex flex-col">
                <label for="activityInput" class="text-xs font-bold text-emerald-400 uppercase">Actividad (Español)</label>
                <textarea id="activityInput" rows="4" placeholder="Describe la solución técnica..." class="mt-1 p-3 border border-gray-600 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-gray-700 text-white"></textarea>
            </div>

            <button id="generateButton" onclick="generateReport()" class="w-full py-4 bg-indigo-600 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-700 transition flex items-center justify-center">
                <span id="generateButtonText">Generar Reporte Profesional</span>
            </button>
        </div>

        <!-- Salida -->
        <div id="output-area" class="hidden animate-in fade-in slide-in-from-bottom-4">
            <h2 class="text-sm font-bold text-gray-400 uppercase mb-2">Reporte Final (Inglés)</h2>
            <pre id="generatedText" class="whitespace-pre-wrap break-words bg-black/30 text-indigo-100 p-4 rounded-lg text-sm border border-indigo-500/20 max-h-60 overflow-y-auto font-mono"></pre>
            <button id="copyButton" onclick="copyToClipboard()" class="mt-3 w-full py-3 bg-emerald-600 text-white font-bold rounded-xl hover:bg-emerald-700 transition flex items-center justify-center gap-2">
                Copiar al Portapapeles
            </button>
        </div>

        <!-- Backup -->
        <div class="pt-4 border-t border-gray-700 flex justify-between gap-4">
             <button onclick="exportClients()" class="text-[10px] text-gray-500 hover:text-gray-300 uppercase font-bold tracking-widest">Exportar Clientes</button>
             <label class="text-[10px] text-gray-500 hover:text-gray-300 uppercase font-bold tracking-widest cursor-pointer">
                Importar JSON
                <input type="file" id="importFileInput" accept=".json" class="hidden" onchange="importClients()"/>
             </label>
        </div>
    </div>
    
    <!-- Modal -->
    <div id="addClientModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-40 p-4">
        <div class="bg-gray-800 rounded-2xl p-6 w-full max-w-sm border border-gray-700 shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-4">Añadir Cliente</h3>
            <input type="text" id="newClientNameInput" placeholder="Nombre de la empresa" class="w-full p-3 border border-gray-600 rounded-xl bg-gray-700 text-white mb-4" />
            <div class="flex gap-2">
                <button onclick="closeModal('addClientModal')" class="flex-1 py-2 bg-gray-600 text-white rounded-xl">Cancelar</button>
                <button id="saveClientBtn" onclick="addNewClient()" class="flex-1 py-2 bg-green-600 text-white rounded-xl font-bold">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notification" class="fixed bottom-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-white text-sm font-bold shadow-2xl opacity-0 transition-all z-50 pointer-events-none"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, onSnapshot, collection, addDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const apiKey = ""; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'report-app-4';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth, userId, clients = [];

        // Inicialización Mejorada
        async function init() {
            try {
                if (!firebaseConfig.apiKey) throw new Error("Configuración faltante");
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Esperar Auth
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Listener de estado
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('authUserId').innerText = userId.substring(0, 8);
                        document.getElementById('aiIndicator').classList.replace('bg-yellow-500', 'bg-emerald-500');
                        document.getElementById('aiIndicator').classList.replace('bg-red-500', 'bg-emerald-500');
                        document.getElementById('aiStatus').innerText = "Conectado";
                        loadClients();
                    } else {
                        document.getElementById('aiStatus').innerText = "Sin Sesión";
                    }
                });
            } catch (e) {
                console.error("Critical Init Error:", e);
                document.getElementById('aiStatus').innerText = "Error DB";
                document.getElementById('aiIndicator').classList.replace('bg-yellow-500', 'bg-red-500');
            }
        }

        function loadClients() {
            if (!userId) return;
            const ref = collection(db, 'artifacts', appId, 'public', 'data', 'clients');
            
            onSnapshot(ref, (snap) => {
                clients = [];
                snap.forEach(doc => clients.push({ id: doc.id, ...doc.data() }));
                updateClientSelect();
            }, (err) => {
                console.error("Firestore Error:", err);
                showToast("Error de permisos DB", "bg-red-600");
            });
        }

        function updateClientSelect() {
            clients.sort((a, b) => (a.name || "").localeCompare(b.name || ""));
            const select = document.getElementById('accountSelect');
            const options = clients.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            select.innerHTML = options || '<option value="" disabled selected>Añade un cliente -> (+)</option>';
        }

        // Gemini API Implementation
        async function translateText(text, retries = 0) {
            const delays = [1000, 2000, 4000];
            const systemPrompt = "Translate this technical support task into professional English. Return ONLY the translation.";
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: text }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || text;
            } catch (err) {
                if (retries < 3) {
                    await new Promise(r => setTimeout(r, delays[retries]));
                    return translateText(text, retries + 1);
                }
                return text;
            }
        }

        window.generateReport = async () => {
            const activity = document.getElementById('activityInput').value.trim();
            if (!activity) return showToast("Falta descripción", "bg-amber-500");

            const btn = document.getElementById('generateButton');
            const btnText = document.getElementById('generateButtonText');
            
            btn.disabled = true;
            btnText.innerHTML = `<div class="spinner mr-2"></div> Procesando...`;

            const finalActivity = await translateText(activity);

            renderReport(finalActivity);
            btn.disabled = false;
            btnText.innerText = "Generar Reporte Profesional";
            document.getElementById('output-area').classList.remove('hidden');
        };

        function renderReport(text) {
            const date = document.getElementById('dateInput').value.split('-').reverse().join('/');
            const client = document.getElementById('accountSelect').value || "N/A";
            const sn = document.getElementById('snInput').value || "N/A";
            const start = document.getElementById('startTimeInput').value;
            const end = document.getElementById('endTimeInput').value;
            
            const formatTime = (t) => {
                if(!t) return "";
                let [h, m] = t.split(':');
                const ampm = h >= 12 ? 'PM' : 'AM';
                h = h % 12 || 12;
                return `${h}:${m} ${ampm}`;
            };

            const timeStr = start && end ? `${formatTime(start)} - ${formatTime(end)}` : (formatTime(start) || "N/A");

            const report = `-- Support Activity Log --\n\n` +
                           `Type: ${document.getElementById('supportType').value}\n` +
                           `Date: ${date}\n` +
                           `Time: ${timeStr}\n\n` +
                           `Account: ${client}\n` +
                           `SN: ${sn}\n\n` +
                           `Activity Performed / Issue:\n${text}`;

            document.getElementById('generatedText').innerText = report;
        }

        // Firestore Guardar con Reintento de Auth
        window.addNewClient = async () => {
            const nameInput = document.getElementById('newClientNameInput');
            const name = nameInput.value.trim();
            const saveBtn = document.getElementById('saveClientBtn');

            if(!name) return showToast("Escribe un nombre", "bg-amber-500");
            
            // Re-intentar obtener userId si es nulo
            const activeUserId = auth.currentUser?.uid || userId;
            if(!activeUserId) return showToast("Error: Sin conexión de usuario", "bg-red-600");

            saveBtn.disabled = true;
            saveBtn.innerText = "Guardando...";

            try {
                const clientsRef = collection(db, 'artifacts', appId, 'public', 'data', 'clients');
                await addDoc(clientsRef, {
                    name: name,
                    uid: activeUserId,
                    timestamp: new Date().getTime()
                });
                
                nameInput.value = "";
                closeModal('addClientModal');
                showToast("¡Cliente guardado con éxito!", "bg-green-600");
            } catch(e) {
                console.error("Save error:", e);
                showToast("Error de permisos en DB", "bg-red-500");
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerText = "Guardar";
            }
        };

        window.copyToClipboard = () => {
            const text = document.getElementById('generatedText').innerText;
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            showToast("¡Texto copiado!", "bg-indigo-600");
        };

        function showToast(msg, color) {
            const t = document.getElementById('notification');
            if (!t) return;
            t.innerText = msg;
            t.className = `fixed bottom-6 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-white text-sm font-bold shadow-2xl transition-all z-50 pointer-events-none ${color} opacity-100`;
            setTimeout(() => t.classList.replace('opacity-100', 'opacity-0'), 3000);
        }

        window.openModal = (id) => {
            document.getElementById(id).classList.replace('hidden', 'flex');
            document.getElementById('newClientNameInput').focus();
        };
        window.closeModal = (id) => document.getElementById(id).classList.replace('flex', 'hidden');

        window.exportClients = () => {
            const data = JSON.stringify(clients, null, 2);
            const blob = new Blob([data], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `backup_clientes.json`; a.click();
        };

        window.importClients = () => {
            const file = document.getElementById('importFileInput').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (Array.isArray(imported)) {
                        for (const c of imported) {
                            if (c.name) {
                                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'clients'), {
                                    name: c.name, uid: userId || 'imported', timestamp: new Date().getTime()
                                });
                            }
                        }
                        showToast("Importación exitosa", "bg-green-600");
                    }
                } catch (err) { showToast("Archivo inválido", "bg-red-600"); }
            };
            reader.readAsText(file);
        };

        document.getElementById('dateInput').value = new Date().toISOString().split('T')[0];
        init();
    </script>
</body>
</html>
